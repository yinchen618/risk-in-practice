# PU Learning è³‡æ–™é è™•ç† ETL ç³»çµ± - ä½¿ç”¨æŒ‡å—

## ç³»çµ±æ¦‚è¿°

æœ¬ç³»çµ±æä¾›å®Œæ•´çš„ PU Learning è³‡æ–™é è™•ç† ETL ç®¡é“ï¼ŒåŒ…å«ï¼š
- å¤šå°ºåº¦ç‰¹å¾µå·¥ç¨‹ï¼ˆ15åˆ†é˜ + 60åˆ†é˜æ™‚é–“çª—å£ï¼‰
- è‡ªå‹•é›»è¡¨æ˜ å°„å’Œæˆ¿é–“é…å°
- æ™‚é–“æˆ³å°é½Šå’Œè³‡æ–™å“è³ªè™•ç†
- å–®ç›¸ä¸‰ç·šé›»åŠ›åˆ†è§£è¨ˆç®—
- æ‰¹æ¬¡è™•ç†èƒ½åŠ›

## æª”æ¡ˆçµæ§‹

```
backend/
â”œâ”€â”€ data_preprocessing_etl_multiscale.py  # ä¸»è¦ETLå¼•æ“
â”œâ”€â”€ etl_config.py                         # é…ç½®è¨­å®š
â”œâ”€â”€ etl_examples.py                       # ä½¿ç”¨ç¯„ä¾‹
â”œâ”€â”€ ETL_README.md                         # è©³ç´°æŠ€è¡“æ–‡æª”
â”œâ”€â”€ meter.csv                             # é›»è¡¨æ˜ å°„æª”æ¡ˆ (189å€‹é›»è¡¨)
â”œâ”€â”€ test_meter_mapping.py                 # é›»è¡¨æ˜ å°„æ¸¬è©¦
â”œâ”€â”€ test_multiscale_features.py           # å¤šå°ºåº¦ç‰¹å¾µæ¸¬è©¦
â””â”€â”€ schema.prisma                         # è³‡æ–™åº«æ¶æ§‹ï¼ˆå·²æ›´æ–°ï¼‰
```

## å¿«é€Ÿé–‹å§‹

### 1. æ¸¬è©¦é›»è¡¨æ˜ å°„åŠŸèƒ½
```bash
cd backend
python3 test_meter_mapping.py
```

### 2. æ¸¬è©¦å¤šå°ºåº¦ç‰¹å¾µå·¥ç¨‹
```bash
python3 test_multiscale_features.py
```

### 3. åŸ·è¡Œå¯¦éš›ETLè™•ç†

#### æ¨¡å¼1ï¼šå–®ä¸€æˆ¿é–“è™•ç†
```python
from data_preprocessing_etl_multiscale import DataPreprocessingETL, RoomInfo, OccupantType

# å‰µå»ºETLå¯¦ä¾‹
etl = DataPreprocessingETL("postgresql://user:pass@localhost/db")

# å®šç¾©æˆ¿é–“è³‡è¨Š
room = RoomInfo(
    building="Building-A",
    floor="1F", 
    room="Room-01",
    meter_id_l1="402A8FB04CDC",
    meter_id_l2="402A8FB028E7",
    occupant_type=OccupantType.OFFICE_WORKER
)

# åŸ·è¡ŒETL
await etl.process_single_room(room, start_date, end_date)
```

#### æ¨¡å¼2ï¼šæ‰¹æ¬¡è™•ç†ï¼ˆå¾CSVï¼‰
```python
# è‡ªå‹•å¾ meter.csv è™•ç†æ‰€æœ‰é›»è¡¨
await etl.process_multiple_rooms_from_csv(
    csv_file="meter.csv",
    start_date=datetime(2024, 1, 1),
    end_date=datetime(2024, 12, 31),
    batch_size=10,  # åŒæ™‚è™•ç†10å€‹æˆ¿é–“
    occupant_type=OccupantType.OFFICE_WORKER
)
```

#### æ¨¡å¼3ï¼šæ¸¬è©¦æ¨¡å¼
```python
# åƒ…æ¸¬è©¦åŠŸèƒ½ï¼Œä¸å¯¦éš›è™•ç†
if __name__ == "__main__":
    asyncio.run(main())  # processing_mode=3
```

## ç³»çµ±ç‰¹è‰²

### ğŸ”„ å¤šå°ºåº¦ç‰¹å¾µå·¥ç¨‹
- **çŸ­æœŸçª—å£ (15åˆ†é˜)**ï¼šæ•æ‰å³æ™‚ç”¨é›»æ¨¡å¼
- **é•·æœŸçª—å£ (60åˆ†é˜)**ï¼šè­˜åˆ¥æŒçºŒæ€§ç•°å¸¸
- **1åˆ†é˜æ­¥é•·**ï¼šé«˜è§£æåº¦æ™‚åºåˆ†æ

### âš¡ é›»åŠ›åˆ†è§£è¨ˆç®—
- **å–®ç›¸ä¸‰ç·šé…ç½®**ï¼šæ­£ç¢ºè™•ç† L1/L2 é›»è¡¨é…å°
- **110V åŠŸç‡**ï¼šL1+L2 å°ä¸­æ€§ç·š
- **220V åŠŸç‡**ï¼šL1 å’Œ L2 ä¹‹é–“å·®å€¼
- **ç¸½åŠŸç‡**ï¼šç¶œåˆè² è¼‰è¨ˆç®—

### ğŸ“Š ç‰¹å¾µé¡å‹ (49å€‹ç¶­åº¦)
- **åŠŸç‡çµ±è¨ˆ**ï¼šå¹³å‡å€¼ã€æ¨™æº–å·®ã€æœ€å¤§å€¼ã€æœ€å°å€¼
- **æ™‚é–“ç‰¹å¾µ**ï¼šå°æ™‚ã€æ˜ŸæœŸã€æœˆä»½ã€å­£ç¯€
- **è®Šç•°åˆ†æ**ï¼šåŠŸç‡è®ŠåŒ–ç‡ã€æ³¢å‹•ç¨‹åº¦
- **è² è¼‰åˆ†è§£**ï¼š110V/220V åˆ†é‡åˆ†æ

### ğŸ”§ è³‡æ–™å“è³ªä¿è­‰
- **æ™‚é–“æˆ³å°é½Š**ï¼šè‡ªå‹•é‡æ¡æ¨£ + å‰å‘å¡«å……
- **ç•°å¸¸æª¢æ¸¬**ï¼šçµ±è¨ˆåŸºæº–ç•°å¸¸æ¨™è¨˜
- **ç¼ºå¤±å€¼è™•ç†**ï¼šæ™ºæ…§æ’å€¼å’Œå¡«è£œ
- **è³‡æ–™é©—è­‰**ï¼šå®Œæ•´æ€§æª¢æŸ¥å’Œå“è³ªå ±å‘Š

## é›»è¡¨æ˜ å°„ (meter.csv)

ç³»çµ±è‡ªå‹•å¾ `meter.csv` è¼‰å…¥é›»è¡¨é…ç½®ï¼š

```csv
ç”µè¡¨å·,ç”µè¡¨åç§°,è®¾å¤‡ç¼–å·
919700039,Building A101,402A8FB04CDC      # L1é›»è¡¨
919700087,Building A101a,402A8FB028E7     # L2é›»è¡¨ï¼ˆ'a'å¾Œç¶´ï¼‰
```

- **ç¸½è¨ˆ**: 187 å€‹é›»è¡¨
- **æˆ¿é–“æ•¸**: 91 å€‹ï¼ˆé…å°æˆåŠŸç‡ 97.8%ï¼‰
- **è‡ªå‹•é…å°**: æ ¹æ“šæˆ¿é–“åç¨± + 'a' å¾Œç¶´é‚è¼¯

## è³‡æ–™åº«æ¶æ§‹

### AnalysisDataset è¡¨
å­˜å„²åŸå§‹åˆ†ææ•¸æ“šé›†è³‡è¨Š
```sql
model AnalysisDataset {
  id               String   @id @default(uuid())
  name             String
  description      String?
  organizationId   String
  createdAt        DateTime @default(now())
  // é—œè¯åˆ°åˆ†æå°±ç·’è³‡æ–™
  analysisData     AnalysisReadyData[]
  organization     Organization @relation(fields: [organizationId])
}
```

### AnalysisReadyData è¡¨  
å­˜å„²è™•ç†å¾Œçš„å¤šå°ºåº¦ç‰¹å¾µ
```sql
model AnalysisReadyData {
  id                    String    @id @default(uuid())
  datasetId             String
  timestamp             DateTime
  room                  String
  // å¤šå°ºåº¦ç‰¹å¾µ (49å€‹æ¬„ä½)
  rawWattageL1          Float
  rawWattageL2          Float
  wattage110v_current   Float
  wattage220v_current   Float
  wattageTotal_current  Float
  // ... æ›´å¤šç‰¹å¾µæ¬„ä½
}
```

## æ€§èƒ½æŒ‡æ¨™

- **è™•ç†é€Ÿåº¦**: ~1000 æ¨£æœ¬/ç§’
- **è¨˜æ†¶é«”ä½¿ç”¨**: <500MB (æ¨™æº–æ‰¹æ¬¡)
- **ä¸¦è¡Œåº¦**: å¯é…ç½® (é è¨­10å€‹æˆ¿é–“åŒæ™‚)
- **å®¹éŒ¯æ€§**: è‡ªå‹•é‡è©¦ + éŒ¯èª¤éš”é›¢

## å¸¸è¦‹å•é¡Œ

### Q: é›»è¡¨é…å°å¤±æ•—æ€éº¼è¾¦ï¼Ÿ
A: æª¢æŸ¥ `meter.csv` ä¸­æ˜¯å¦æœ‰å°æ‡‰çš„ 'a' å¾Œç¶´é›»è¡¨ã€‚ç³»çµ±æœƒè¨˜éŒ„æœªé…å°çš„é›»è¡¨ä¸¦ç¹¼çºŒè™•ç†å…¶ä»–æˆ¿é–“ã€‚

### Q: æ™‚é–“æˆ³ä¸å°é½Šå•é¡Œï¼Ÿ
A: ç³»çµ±è‡ªå‹•ä½¿ç”¨é‡æ¡æ¨£æŠ€è¡“å°é½Šæ™‚é–“æˆ³ï¼Œæ”¯æ´æœ€å¤š10ç§’çš„æ™‚é–“æ¼‚ç§»ä¿®æ­£ã€‚

### Q: ç‰¹å¾µç¶­åº¦å¤ªå¤šï¼Ÿ
A: å¯ä»¥åœ¨ `etl_config.py` ä¸­èª¿æ•´ç‰¹å¾µé¸æ“‡ï¼Œæˆ–ä½¿ç”¨é™ç¶­æŠ€è¡“è™•ç†ã€‚

### Q: è¨˜æ†¶é«”ä¸è¶³ï¼Ÿ
A: æ¸›å°‘ `batch_size` åƒæ•¸ï¼Œæˆ–ä½¿ç”¨åˆ†æ®µè™•ç†è¼ƒé•·æ™‚é–“ç¯„åœçš„è³‡æ–™ã€‚

## ä¸‹ä¸€æ­¥

1. **é©—è­‰æ¸¬è©¦çµæœ**ï¼šç¢ºèªæ¸¬è©¦è…³æœ¬è¼¸å‡ºç¬¦åˆé æœŸ
2. **é…ç½®çœŸå¯¦è³‡æ–™åº«**ï¼šæ›´æ–°é€£æ¥å­—ä¸²åˆ° PostgreSQL
3. **åŸ·è¡Œæ­·å²è³‡æ–™**ï¼šæ‰¹æ¬¡è™•ç†æ—¢æœ‰çš„é›»è¡¨è³‡æ–™
4. **ç›£æ§å’Œèª¿å„ª**ï¼šæ ¹æ“šå¯¦éš›æ€§èƒ½èª¿æ•´åƒæ•¸

## æ”¯æ´

å¦‚æœ‰å•é¡Œï¼Œè«‹æª¢æŸ¥ï¼š
1. æ—¥èªŒæª”æ¡ˆä¸­çš„è©³ç´°éŒ¯èª¤è¨Šæ¯
2. è³‡æ–™åº«é€£æ¥å’Œæ¬Šé™è¨­å®š
3. `meter.csv` æª”æ¡ˆæ ¼å¼å’Œç·¨ç¢¼
4. Python ä¾è³´å¥—ä»¶ç‰ˆæœ¬

---
*æœ€å¾Œæ›´æ–°: 2025-08-23*  
*ç³»çµ±ç‰ˆæœ¬: v1.0 (å¤šå°ºåº¦ç‰¹å¾µå·¥ç¨‹ + CSVæ•´åˆ)*
