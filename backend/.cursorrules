# Backend Architecture Rules for Smart Meter Testbed

## ğŸ“‹ **Architecture Principles**

### **Single Source of Truth**
- æ¯å€‹åŠŸèƒ½æ¨¡çµ„åªèƒ½æœ‰ä¸€å€‹ä¸»è¦å¯¦ç¾æª”æ¡ˆ
- é¿å…é‡è¤‡çš„ API ç«¯é»å’Œæœå‹™é‚è¼¯
- ä½¿ç”¨çµ±ä¸€çš„è³‡æ–™æ¨¡å‹å’Œä»‹é¢

### **Module Hierarchy**
```
backend/
â”œâ”€â”€ core/                    # æ ¸å¿ƒæ¨¡çµ„
â”‚   â”œâ”€â”€ database.py         # è³‡æ–™åº«ç®¡ç†ï¼ˆå–®ä¸€æª”æ¡ˆï¼‰
â”‚   â”œâ”€â”€ config.py           # é…ç½®ç®¡ç†
â”‚   â””â”€â”€ exceptions.py       # è‡ªè¨‚ä¾‹å¤–
â”œâ”€â”€ services/               # æ¥­å‹™é‚è¼¯æœå‹™
â”‚   â”œâ”€â”€ testbed_service.py  # Testbed æ ¸å¿ƒæœå‹™ï¼ˆä¸»è¦ï¼‰
â”‚   â”œâ”€â”€ ammeter_service.py  # é›»è¡¨æœå‹™ï¼ˆæ•´åˆï¼‰
â”‚   â””â”€â”€ ai_service.py       # AI å­¸ç¿’æœå‹™
â”œâ”€â”€ routes/                 # API è·¯ç”±
â”‚   â”œâ”€â”€ testbed.py         # Testbed APIï¼ˆå–®ä¸€ç«¯é»ï¼‰
â”‚   â”œâ”€â”€ ammeters.py        # é›»è¡¨ APIï¼ˆæ•´åˆï¼‰
â”‚   â””â”€â”€ ai.py              # AI API
â”œâ”€â”€ models/                 # è³‡æ–™æ¨¡å‹
â”‚   â”œâ”€â”€ testbed.py         # Testbed ç›¸é—œæ¨¡å‹
â”‚   â”œâ”€â”€ ammeter.py         # é›»è¡¨ç›¸é—œæ¨¡å‹
â”‚   â””â”€â”€ base.py            # åŸºç¤æ¨¡å‹
â””â”€â”€ main.py                # ä¸»ç¨‹å¼ï¼ˆå–®ä¸€å…¥å£ï¼‰
```

### **File Naming Convention**
- **Services**: `{åŠŸèƒ½}_service.py` - æ¥­å‹™é‚è¼¯å¯¦ç¾
- **Routes**: `{åŠŸèƒ½}.py` - API ç«¯é»å®šç¾©  
- **Models**: `{åŠŸèƒ½}.py` - è³‡æ–™æ¨¡å‹
- **Core**: åŸºç¤è¨­æ–½å’Œå…±ç”¨åŠŸèƒ½

## ğŸš« **Prohibited Patterns**

### **é‡è¤‡æª”æ¡ˆ (DELETE)**
- âŒ `ammeter_api.py` - æ•´åˆåˆ° `services/ammeter_service.py`
- âŒ `ammeters_api.py` - æ•´åˆåˆ° `services/ammeter_service.py` 
- âŒ `routes/ammeter.py` - æ•´åˆåˆ° `routes/ammeters.py`
- âŒ `main_unified.py` - ä½¿ç”¨çµ±ä¸€çš„ `main.py`
- âŒ å¤šå€‹ start script - ä½¿ç”¨å–®ä¸€å•Ÿå‹•æª”æ¡ˆ

### **API é‡è¤‡ (CONSOLIDATE)**
- æ¯å€‹è³‡æºåªèƒ½æœ‰ä¸€å€‹ API ç«¯é»é›†åˆ
- ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶è€Œéé‡è¤‡æª”æ¡ˆ
- çµ±ä¸€éŒ¯èª¤è™•ç†å’Œå›æ‡‰æ ¼å¼

### **å‡½æ•¸é‡è¤‡ (EXTRACT)**
- é‡è¤‡çš„ API è«‹æ±‚é‚è¼¯ â†’ æå–åˆ° `services/`
- é‡è¤‡çš„è³‡æ–™è§£æé‚è¼¯ â†’ æå–åˆ° `models/`
- é‡è¤‡çš„è³‡æ–™åº«æ“ä½œ â†’ æ•´åˆåˆ° `core/database.py`

## âœ… **Required Patterns**

### **Service Layer Pattern**
```python
# services/testbed_service.py
class TestbedService:
    """Testbed æ ¸å¿ƒæ¥­å‹™é‚è¼¯ï¼ˆå–®ä¾‹ï¼‰"""
    
    def __init__(self):
        self.db = DatabaseManager()
        self.ammeter_service = AmmeterService()
    
    async def get_overview(self) -> TestbedOverview:
        """ç²å–æ¦‚è¦½ï¼ˆæ•´åˆæ‰€æœ‰è³‡æ–™æºï¼‰"""
        
    async def get_units(self) -> List[TestbedUnit]:
        """ç²å–ä½å®…å–®ä½ï¼ˆå»é‡å’Œæ¨™æº–åŒ–ï¼‰"""
```

### **Unified API Response**
```python
# All APIs must use consistent response format
class APIResponse(BaseModel):
    success: bool
    data: Optional[Any] = None
    message: Optional[str] = None
    error: Optional[str] = None
```

### **Database Abstraction**
```python
# core/database.py - Single database manager
class DatabaseManager:
    """çµ±ä¸€çš„è³‡æ–™åº«ç®¡ç†å™¨"""
    
    async def get_ammeter_data(self, device_id: str) -> AmmeterData:
        """çµ±ä¸€çš„é›»è¡¨è³‡æ–™æŸ¥è©¢"""
    
    async def save_ammeter_log(self, log_data: dict) -> None:
        """çµ±ä¸€çš„æ—¥èªŒè¨˜éŒ„"""
```

## ğŸ”„ **Integration Rules**

### **Data Flow Hierarchy**
```
Frontend (apps/phd) 
    â†“ API calls
packages/api/src/routes/testbed.ts (Hono middleware)
    â†“ Proxy to Python
backend/routes/testbed.py (FastAPI routes)
    â†“ Business logic
backend/services/testbed_service.py (Core service)
    â†“ Data access
backend/core/database.py (Database layer)
```

### **Import Rules**
- Routes åªèƒ½ import Services
- Services åªèƒ½ import Core å’Œ Models
- Core æ¨¡çµ„ä¸èƒ½ import Services æˆ– Routes
- ç¦æ­¢å¾ªç’° import

### **Error Handling**
- çµ±ä¸€çš„ä¾‹å¤–è™•ç†æ©Ÿåˆ¶
- API å±¤ï¼šHTTP ä¾‹å¤–è½‰æ›
- Service å±¤ï¼šæ¥­å‹™é‚è¼¯ä¾‹å¤–
- Core å±¤ï¼šåŸºç¤è¨­æ–½ä¾‹å¤–

## ğŸ“ **Migration Tasks**

### **Phase 1: Consolidation**
1. åˆªé™¤é‡è¤‡çš„ API æª”æ¡ˆ
2. æ•´åˆé›»è¡¨æœå‹™é‚è¼¯
3. çµ±ä¸€è³‡æ–™æ¨¡å‹

### **Phase 2: Refactoring**
1. å¯¦ç¾ Service Layer Pattern
2. çµ±ä¸€éŒ¯èª¤è™•ç†
3. æ¨™æº–åŒ– API å›æ‡‰æ ¼å¼

### **Phase 3: Testing**
1. ç«¯åˆ°ç«¯æ¸¬è©¦è³‡æ–™æµç¨‹
2. API æ•´åˆæ¸¬è©¦
3. å‰ç«¯åŠŸèƒ½é©—è­‰

## ğŸ¯ **Success Criteria**

- âœ… é›¶é‡è¤‡æª”æ¡ˆ
- âœ… æ¸…æ™°çš„æ¨¡çµ„é‚Šç•Œ
- âœ… çµ±ä¸€çš„è³‡æ–™æµç¨‹
- âœ… å®Œæ•´çš„åŠŸèƒ½æ¸¬è©¦
- âœ… å‰ç«¯æ­£å¸¸é‹ä½œ

Remember: **One Feature, One File, One Responsibility**
